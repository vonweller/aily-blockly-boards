name: Board Configuration Compliance Check

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '*/package.json'
      - '*/template/package.json'
  push:
    branches: [ main, develop ]
    paths:
      - '*/package.json'
      - '*/template/package.json'

# GitHub Actionsæƒé™é…ç½®
permissions:
  contents: read            # è¯»å–ä»“åº“å†…å®¹å’Œä»£ç 
  pull-requests: write      # å†™å…¥PRè¯„è®ºå’ŒçŠ¶æ€
  issues: write            # å†™å…¥issueè¯„è®ºï¼ˆPRä¹Ÿæ˜¯ç‰¹æ®Šçš„issueï¼‰
  actions: read            # è¯»å–workflowè¿è¡ŒçŠ¶æ€
  checks: read             # è¯»å–æ£€æŸ¥çŠ¶æ€
  statuses: read           # è¯»å–çŠ¶æ€æ£€æŸ¥

jobs:
  validate-boards:
    runs-on: ubuntu-latest
    # åœ¨jobçº§åˆ«ä¹Ÿæ˜ç¡®æƒé™ï¼ˆå¯é€‰ï¼Œä½†æ›´å®‰å…¨ï¼‰
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Get changed boards
      id: changed-boards
      run: |
        echo "æ£€æµ‹å˜æ›´çš„å¼€å‘æ¿æ–‡ä»¶..."
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PRæ¨¡å¼ï¼šæ¯”è¾ƒPRåˆ†æ”¯ä¸ç›®æ ‡åˆ†æ”¯
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        else
          # Pushæ¨¡å¼ï¼šæ¯”è¾ƒå½“å‰æäº¤ä¸ä¸Šä¸€ä¸ªæäº¤
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        fi
        
        echo "å˜æ›´çš„æ–‡ä»¶:"
        echo "$CHANGED_FILES"
        
        # æå–å˜æ›´çš„å¼€å‘æ¿ç›®å½•
        CHANGED_BOARDS=""
        while IFS= read -r file; do
          if [[ "$file" =~ ^([^/]+)/(package\.json|template/package\.json)$ ]]; then
            board_name="${BASH_REMATCH[1]}"
            # æ’é™¤æ ¹ç›®å½•å’Œç‰¹æ®Šç›®å½•
            if [[ "$board_name" != "package.json" ]] && \
               [[ "$board_name" != "å‚è€ƒ" ]] && \
               [[ "$board_name" != .* ]] && \
               [[ "$board_name" != "node_modules" ]]; then
              if [[ -z "$CHANGED_BOARDS" ]]; then
                CHANGED_BOARDS="$board_name"
              elif [[ "$CHANGED_BOARDS" != *"$board_name"* ]]; then
                CHANGED_BOARDS="$CHANGED_BOARDS,$board_name"
              fi
            fi
          fi
        done <<< "$CHANGED_FILES"
        
        echo "å˜æ›´çš„å¼€å‘æ¿:"
        echo "$CHANGED_BOARDS"
        
        # è®¾ç½®è¾“å‡º
        echo "boards=$CHANGED_BOARDS" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ£€æµ‹çš„å¼€å‘æ¿
        if [ -z "$CHANGED_BOARDS" ]; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Validate changed boards
      if: steps.changed-boards.outputs.has_changes == 'true'
      id: validation
      run: |
        echo "å¼€å§‹æ£€æµ‹å˜æ›´çš„å¼€å‘æ¿..."
        
        # æ£€æŸ¥éªŒè¯è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "validate-boards-compliance.js" ]; then
          echo "âŒ é”™è¯¯: validate-boards-compliance.js è„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        
        # è®¾ç½®éªŒè¯ç»“æœå˜é‡
        VALIDATION_PASSED="true"
        TOTAL_ERRORS=0
        TOTAL_WARNINGS=0
        
        # ä½¿ç”¨å¼€å‘æ¿é…ç½®éªŒè¯å™¨
        if [ -n "${{ steps.changed-boards.outputs.boards }}" ]; then
          # å°†é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºç©ºæ ¼åˆ†éš”çš„å‚æ•°
          BOARDS="${{ steps.changed-boards.outputs.boards }}"
          BOARDS_ARGS=$(echo "$BOARDS" | tr ',' ' ')
          
          echo "æ£€æµ‹å¼€å‘æ¿: $BOARDS_ARGS"
          
          # é€ä¸ªæ£€æµ‹æ¯ä¸ªå¼€å‘æ¿
          for board in $BOARDS_ARGS; do
            echo "æ­£åœ¨æ£€æµ‹å¼€å‘æ¿: $board"
            if ! node validate-boards-compliance.js "$board"; then
              VALIDATION_PASSED="false"
              echo "å¼€å‘æ¿ $board æ£€æµ‹å¤±è´¥"
            else
              echo "å¼€å‘æ¿ $board æ£€æµ‹é€šè¿‡"
            fi
          done
        else
          echo "ä½¿ç”¨Gitå˜æ›´æ£€æµ‹æ¨¡å¼"
          if ! node validate-boards-compliance.js --changed; then
            VALIDATION_PASSED="false"
          fi
        fi
        
        echo "validation_passed=$VALIDATION_PASSED" >> $GITHUB_OUTPUT
        
        # å¦‚æœéªŒè¯å¤±è´¥ï¼Œè®¾ç½®éé›¶é€€å‡ºç 
        if [ "$VALIDATION_PASSED" = "false" ]; then
          echo "ğŸ’¥ å¼€å‘æ¿é…ç½®æ£€æµ‹å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶ä¿®å¤é—®é¢˜"
          exit 1
        else
          echo "ğŸ‰ æ‰€æœ‰å¼€å‘æ¿å‡é€šè¿‡é…ç½®æ£€æµ‹ï¼"
        fi

    - name: No changes detected
      if: steps.changed-boards.outputs.has_changes == 'false'
      run: |
        echo "â„¹ï¸ æœªæ£€æµ‹åˆ°éœ€è¦éªŒè¯çš„å¼€å‘æ¿é…ç½®å˜æ›´"
        echo "å˜æ›´æ£€æµ‹èŒƒå›´: package.json, template/package.json"

    - name: Comment PR with results
      if: github.event_name == 'pull_request' && steps.changed-boards.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        # æ˜ç¡®æŒ‡å®šGitHub Tokenï¼Œç¡®ä¿æƒé™æ­£ç¡®
        github-token: ${{ github.token }}
        # è®¾ç½®é‡è¯•æœºåˆ¶
        retries: 3
        retry-exempt-status-codes: 400,401,403,404,422
        script: |
          console.log('ğŸ” å¼€å§‹PRè¯„è®ºæ“ä½œ...');
          console.log(`ä»“åº“: ${context.repo.owner}/${context.repo.repo}`);
          console.log(`PRå·: ${context.issue.number}`);
          console.log(`äº‹ä»¶ç±»å‹: ${context.eventName}`);
          console.log(`Actor: ${context.actor}`);
          
          // éªŒè¯åŸºæœ¬æƒé™
          console.log('ğŸ” éªŒè¯åŸºæœ¬æƒé™...');
          try {
            const repoInfo = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            console.log('âœ… ä»“åº“è¯»å–æƒé™æ­£å¸¸');
          } catch (permError) {
            console.error('âŒ åŸºæœ¬æƒé™éªŒè¯å¤±è´¥:', permError.message);
            throw new Error(`æƒé™ä¸è¶³: ${permError.message}`);
          }
          
          try {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ£€æµ‹æœºå™¨äººè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // æŸ¥æ‰¾ç°æœ‰çš„æ£€æµ‹è¯„è®º
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ¤– å¼€å‘æ¿é…ç½®æ£€æµ‹')
            );
            
            // è·å–æ£€æµ‹ç»“æœçŠ¶æ€
            const validationPassed = '${{ steps.validation.outputs.validation_passed }}' === 'true';
            const statusIcon = validationPassed ? 'âœ…' : 'âŒ';
            const statusText = validationPassed ? 'é€šè¿‡æ£€æµ‹' : 'æ£€æµ‹å¤±è´¥';
            const changedBoards = '${{ steps.changed-boards.outputs.boards }}';
            
            const comment = "## ğŸ¤– å¼€å‘æ¿é…ç½®æ£€æµ‹" + statusText + " " + statusIcon + "\n\n" +
            (changedBoards ? "ğŸ“¦ **æ£€æµ‹èŒƒå›´**: " + changedBoards.replace(/,/g, ', ') : "ğŸ“¦ **æ£€æµ‹æ¨¡å¼**: Gitå˜æ›´æ£€æµ‹") + "\n\n" +
            "ğŸ“Š **è¯¦ç»†æŠ¥å‘Š**: æŸ¥çœ‹ä¸Šæ–¹çš„ [Actions Summary](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) è·å–å®Œæ•´ç»“æœ\n\n" +
            (validationPassed ? 
              "ğŸ‰ **æ­å–œï¼** æ‰€æœ‰å˜æ›´å¼€å‘æ¿å‡ç¬¦åˆé…ç½®è§„èŒƒï¼\n\n" +
              "âœ¨ **ä¸»è¦æ£€æµ‹é¡¹**:\n" +
              "- ğŸ“¦ ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æµ‹ âœ…\n" +
              "- ğŸ› ï¸ SDKç‰ˆæœ¬åŒ¹é…æ£€æµ‹ âœ…\n" +  
              "- ğŸ“‹ åŸºç¡€å­—æ®µå®Œæ•´æ€§ âœ…\n" +
              "- ğŸ”— Templateä¾èµ–é…ç½® âœ…" :
              "âš ï¸ **éœ€è¦ä¿®å¤** éƒ¨åˆ†å¼€å‘æ¿é…ç½®ä¸ç¬¦åˆè§„èŒƒè¦æ±‚\n\n" +
              "ğŸ”§ **ä¿®å¤æ­¥éª¤**:\n" +
              "1. æŸ¥çœ‹ä¸Šæ–¹Actions Summaryçš„è¯¦ç»†é”™è¯¯ä¿¡æ¯\n" +
              "2. å‚è€ƒä¸‹æ–¹è§„èŒƒæ–‡æ¡£è¿›è¡Œä¿®å¤\n" +
              "3. é‡æ–°æäº¤ä»£ç è§¦å‘æ£€æµ‹"
            ) + "\n\n" +
            "ğŸ’¡ **æœ¬åœ°æ£€æµ‹**: \n" +
            "```bash\n" +
            "# æ£€æµ‹æŒ‡å®šå¼€å‘æ¿\n" +
            "node validate-boards-compliance.js <å¼€å‘æ¿å>\n\n" +
            "# æ£€æµ‹æ‰€æœ‰å¼€å‘æ¿\n" +
            "node validate-boards-compliance.js --all\n\n" +
            "# æ£€æµ‹å˜æ›´çš„å¼€å‘æ¿\n" +
            "node validate-boards-compliance.js --changed\n" +
            "```\n\n" +
            "ğŸ“– **è§„èŒƒæ–‡æ¡£**: \n" +
            "- [å¼€å‘æ¿è§„èŒƒ](https://github.com/${{ github.repository }}/blob/main/å¼€å‘æ¿è§„èŒƒ.md)\n" +
            "- [å¼€å‘æ¿é€‚é…](https://github.com/${{ github.repository }}/blob/main/å¼€å‘æ¿é€‚é….md)\n\n" +
            "---\n" +
            "*æ£€æµ‹ç”± [å¼€å‘æ¿é…ç½®æ£€æµ‹ç³»ç»Ÿ](https://github.com/${{ github.repository }}/blob/main/validate-boards-compliance.js) è‡ªåŠ¨å®Œæˆ | è¿è¡ŒID: ${{ github.run_id }}*";
            
            if (botComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('âœ… å·²æ›´æ–°ç°æœ‰æ£€æµ‹è¯„è®º');
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('âœ… å·²æ·»åŠ æ–°çš„æ£€æµ‹è¯„è®º');
            }
          } catch (error) {
            console.error('âŒ è¯„è®ºæ“ä½œå¤±è´¥:', error.message);
            console.error('é”™è¯¯çŠ¶æ€ç :', error.status);
            console.error('é”™è¯¯è¯¦æƒ…:', JSON.stringify(error.response?.data || error, null, 2));
            
            // è¯¦ç»†æƒé™è¯Šæ–­
            console.log('');
            console.log('ğŸ”§ è¯¦ç»†æƒé™è¯Šæ–­:');
            console.log(`é”™è¯¯ç±»å‹: ${error.name}`);
            console.log(`HTTPçŠ¶æ€: ${error.status}`);
            console.log(`è¯·æ±‚URL: ${error.request?.url || 'unknown'}`);
            
            // æ ¹æ®é”™è¯¯ç±»å‹æä¾›å…·ä½“å»ºè®®
            if (error.status === 403) {
              console.log('');
              console.log('ğŸš¨ 403æƒé™é”™è¯¯ - æ£€æŸ¥ä»¥ä¸‹è®¾ç½®:');
              console.log('1. ä»“åº“è®¾ç½® â†’ Actions â†’ General â†’ Workflow permissions');
              console.log('   âœ… åº”é€‰æ‹©: "Read and write permissions"');
              console.log('2. ä»“åº“è®¾ç½® â†’ Actions â†’ General');
              console.log('   âœ… å¯ç”¨: "Allow GitHub Actions to create and approve pull requests"');
              console.log('3. åˆ†æ”¯ä¿æŠ¤è§„åˆ™ä¸åº”é˜»æ­¢botæ“ä½œ');
              console.log('4. ç¡®è®¤ä»“åº“ä¸æ˜¯privateä¸”actionsæœ‰è¶³å¤Ÿæƒé™');
              
              // æ£€æŸ¥tokenç±»å‹
              console.log('');
              console.log('ğŸ”‘ Tokenè¯Šæ–­:');
              console.log(`ä½¿ç”¨çš„token: github.token (æ¨è)`);
              console.log(`ä¸Šä¸‹æ–‡actor: ${context.actor}`);
            }
            
            // ä¸è®©è¯„è®ºå¤±è´¥é˜»æ­¢æ•´ä¸ªworkflow
            console.log('');
            console.log('ğŸ’¡ æ£€æµ‹ç»“æœå·²ä¿å­˜åœ¨Actions Summaryä¸­');
            console.log('ğŸ’¡ å¯ä»¥æ‰‹åŠ¨æŸ¥çœ‹workflowè¿è¡Œç»“æœ');
            
            // è®¾ç½®workflowçŠ¶æ€ï¼Œå³ä½¿è¯„è®ºå¤±è´¥ä¹Ÿä¸å½±å“æ£€æµ‹ç»“æœ
            console.log('ç»§ç»­æ‰§è¡Œworkflow...');
          }

    # å¤‡ç”¨é€šçŸ¥æ–¹æ¡ˆ - ä½¿ç”¨ç®€å•çš„echoè¾“å‡º
    - name: Fallback notification
      if: failure() && github.event_name == 'pull_request'
      run: |
        echo "ğŸ”” å¤‡ç”¨é€šçŸ¥æœºåˆ¶:"
        echo "ç”±äºæƒé™é™åˆ¶ï¼Œæ— æ³•ç›´æ¥åœ¨PRä¸­è¯„è®º"
        echo "è¯·è®¿é—®Actionsé¡µé¢æŸ¥çœ‹è¯¦ç»†çš„å¼€å‘æ¿é…ç½®æ£€æµ‹ç»“æœ"
        echo "é“¾æ¥: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"