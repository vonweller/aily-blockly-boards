name: Boards Compliance Check

on:
  pull_request:
    branches: [ main, deploy, develop ]
    paths:
      - '*/package.json'
      - '*/template/package.json'
      - '*/board.json'
      - '*/readme.md'
  push:
    branches: [ main, deploy, develop ]
    paths:
      - '*/package.json'
      - '*/template/package.json'
      - '*/board.json'
      - '*/readme.md'

# GitHub Actionsæƒé™é…ç½®
permissions:
  contents: read            # è¯»å–ä»“åº“å†…å®¹å’Œä»£ç 
  pull-requests: write      # å†™å…¥PRè¯„è®ºå’ŒçŠ¶æ€
  issues: write            # å†™å…¥issueè¯„è®ºï¼ˆPRä¹Ÿæ˜¯ç‰¹æ®Šçš„issueï¼‰
  actions: read            # è¯»å–workflowè¿è¡ŒçŠ¶æ€
  checks: read             # è¯»å–æ£€æŸ¥çŠ¶æ€
  statuses: read           # è¯»å–çŠ¶æ€æ£€æŸ¥

jobs:
  validate-boards:
    runs-on: ubuntu-latest
    name: éªŒè¯å¼€å‘æ¿é…ç½®è§„èŒƒ
    
    # åœ¨jobçº§åˆ«ä¹Ÿæ˜ç¡®æƒé™ï¼ˆå¯é€‰ï¼Œä½†æ›´å®‰å…¨ï¼‰
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºæ¯”è¾ƒåˆ†æ”¯å·®å¼‚

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: éªŒè¯å˜æ›´çš„å¼€å‘æ¿
      id: validation
      run: |
        echo "ğŸ” å¼€å§‹æ£€æµ‹å˜æ›´çš„å¼€å‘æ¿..."
        
        # æ‰§è¡Œæ£€æµ‹è„šæœ¬
        if ! node validate-boards-compliance.js --changed; then
          echo "validation_passed=false" >> $GITHUB_OUTPUT
          echo "ğŸ’¥ å¼€å‘æ¿è§„èŒƒæ£€æµ‹å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶ä¿®å¤é—®é¢˜"
          exit 1
        else
          echo "validation_passed=true" >> $GITHUB_OUTPUT
          echo "ğŸ‰ æ‰€æœ‰å¼€å‘æ¿å‡é€šè¿‡è§„èŒƒæ£€æµ‹ï¼"
        fi

    - name: åœ¨ PR ä¸­è¯„è®ºæ£€æµ‹ç»“æœ
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ github.token }}
        retries: 3
        retry-exempt-status-codes: 400,401,403,404,422
        script: |
          console.log('ğŸ” å¼€å§‹PRè¯„è®ºæ“ä½œ...');
          
          try {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ£€æµ‹æœºå™¨äººè¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // æŸ¥æ‰¾ç°æœ‰çš„æ£€æµ‹è¯„è®º
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ¤– å¼€å‘æ¿è§„èŒƒæ£€æµ‹')
            );
            
            // è·å–æ£€æµ‹ç»“æœçŠ¶æ€
            const validationPassed = '${{ steps.validation.outputs.validation_passed }}' === 'true';
            const statusIcon = validationPassed ? 'âœ…' : 'âŒ';
            const statusText = validationPassed ? 'é€šè¿‡æ£€æµ‹' : 'æ£€æµ‹å¤±è´¥';
            
            // æ„å»ºè¯„è®ºå†…å®¹
            let comment = '## ğŸ¤– å¼€å‘æ¿è§„èŒƒæ£€æµ‹ ' + statusText + ' ' + statusIcon + '\n\n';
            comment += 'ğŸ“¦ **æ£€æµ‹æ¨¡å¼**: è‡ªåŠ¨æ£€æµ‹ PR ä¸­å˜æ›´çš„å¼€å‘æ¿\n\n';
            comment += 'ğŸ“Š **è¯¦ç»†æŠ¥å‘Š**: æŸ¥çœ‹ä¸Šæ–¹çš„ [Actions Summary](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) è·å–å®Œæ•´ç»“æœ\n\n';
            
            if (validationPassed) {
              comment += 'ğŸ‰ **æ­å–œï¼** æ‰€æœ‰å˜æ›´å¼€å‘æ¿å‡ç¬¦åˆè§„èŒƒè¦æ±‚ï¼\n\n';
              comment += 'âœ¨ **ä¸»è¦æ£€æµ‹é¡¹**:\n';
              comment += '- ğŸ“¦ Boardä¾èµ–å”¯ä¸€æ€§å’Œæ­£ç¡®æ€§ âœ…\n';
              comment += '- ğŸ·ï¸ Boardä¾èµ–åç§°åŒ¹é…ï¼ˆå¿…é¡»å°å†™ï¼‰âœ…\n';
              comment += '- ğŸ”¢ Boardä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§ âœ…\n';
              comment += '- ğŸ¯ Boardå­—æ®µä¸nicknameå­—æ®µä¸€è‡´æ€§ âœ…\n';
              comment += '- ğŸ› ï¸ SDKç‰ˆæœ¬åŒ¹é…æ£€æµ‹ âœ…\n';
              comment += '- ğŸ“‹ åŸºç¡€å­—æ®µå®Œæ•´æ€§ âœ…\n';
            } else {
              comment += 'âš ï¸ **éœ€è¦ä¿®å¤** éƒ¨åˆ†å¼€å‘æ¿ä¸ç¬¦åˆè§„èŒƒè¦æ±‚\n\n';
              comment += 'ğŸ”§ **ä¿®å¤æ­¥éª¤**:\n';
              comment += '1. æŸ¥çœ‹ä¸Šæ–¹ Actions Summary çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯\n';
              comment += '2. å‚è€ƒä¸‹æ–¹è§„èŒƒæ–‡æ¡£è¿›è¡Œä¿®å¤\n';
              comment += '3. é‡æ–°æäº¤ä»£ç è§¦å‘æ£€æµ‹\n';
            }
            
            comment += '\nğŸ’¡ **æœ¬åœ°æ£€æµ‹**: \n';
            comment += '```bash\n';
            comment += '# æ£€æµ‹å˜æ›´çš„å¼€å‘æ¿\n';
            comment += 'node validate-boards-compliance.js --changed\n\n';
            comment += '# æ£€æµ‹æŒ‡å®šå¼€å‘æ¿\n';
            comment += 'node validate-boards-compliance.js <å¼€å‘æ¿å>\n\n';
            comment += '# æ£€æµ‹æ‰€æœ‰å¼€å‘æ¿\n';
            comment += 'node validate-boards-compliance.js --all\n';
            comment += '```\n\n';
            comment += 'ğŸ“– **è§„èŒƒæ–‡æ¡£**: \n';
            comment += '- [å¼€å‘æ¿è§„èŒƒ](https://github.com/${{ github.repository }}/blob/main/å¼€å‘æ¿è§„èŒƒ.md)\n';
            comment += '- [å¼€å‘æ¿é€‚é…](https://github.com/${{ github.repository }}/blob/main/å¼€å‘æ¿é€‚é….md)\n\n';
            comment += '---\n';
            comment += '*æ£€æµ‹ç”± [å¼€å‘æ¿è§„èŒƒæ£€æµ‹ç³»ç»Ÿ](https://github.com/${{ github.repository }}/blob/main/validate-boards-compliance.js) è‡ªåŠ¨å®Œæˆ | è¿è¡ŒID: ${{ github.run_id }}*';
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('âœ… å·²æ›´æ–°ç°æœ‰æ£€æµ‹è¯„è®º');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('âœ… å·²æ·»åŠ æ–°çš„æ£€æµ‹è¯„è®º');
            }
          } catch (error) {
            console.error('âŒ è¯„è®ºæ“ä½œå¤±è´¥:', error.message);
            console.log('ğŸ’¡ æ£€æµ‹ç»“æœå·²ä¿å­˜åœ¨ Actions Summary ä¸­');
          }

    # å¤‡ç”¨é€šçŸ¥æ–¹æ¡ˆ - ä½¿ç”¨ç®€å•çš„echoè¾“å‡º
    - name: å¤‡ç”¨é€šçŸ¥æœºåˆ¶
      if: failure() && github.event_name == 'pull_request'
      run: |
        echo "ğŸ”” å¤‡ç”¨é€šçŸ¥æœºåˆ¶:"
        echo "ç”±äºæƒé™é™åˆ¶ï¼Œæ— æ³•ç›´æ¥åœ¨PRä¸­è¯„è®º"
        echo "è¯·è®¿é—®Actionsé¡µé¢æŸ¥çœ‹è¯¦ç»†çš„å¼€å‘æ¿è§„èŒƒæ£€æµ‹ç»“æœ"
        echo "é“¾æ¥: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

    # ä¸ºä¸»åˆ†æ”¯ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
    - name: ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/deploy')
      run: |
        echo "ğŸ“Š ç”Ÿæˆå¼€å‘æ¿ç»Ÿè®¡æŠ¥å‘Š..."
        node validate-boards-compliance.js --all > boards-report.txt || true
        cat boards-report.txt
        
    - name: ä¸Šä¼ æŠ¥å‘Š
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/deploy')
      uses: actions/upload-artifact@v4
      with:
        name: boards-compliance-report
        path: boards-report.txt
        retention-days: 30
